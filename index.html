<!DOCTYPE html>
<html>
<head>
    <title>WebRTC Audio Example</title>
</head>
<body>
    <h1>WebRTC Audio Example</h1>
    <audio id="remoteAudio" autoplay></audio>
    <script>
        const signalingServer = new WebSocket('ws://localhost:8080');
        let localConnection;
        let remoteStream;

        signalingServer.onmessage = (message) => {
            const data = JSON.parse(message.data);
            switch (data.type) {
                case 'offer':
                    handleOffer(data.offer);
                    break;
                case 'answer':
                    handleAnswer(data.answer);
                    break;
                case 'candidate':
                    handleCandidate(data.candidate);
                    break;
                default:
                    break;
            }
        };

        const handleOffer = async (offer) => {
            await localConnection.setRemoteDescription(new RTCSessionDescription(offer));
            const answer = await localConnection.createAnswer();
            await localConnection.setLocalDescription(answer);
            signalingServer.send(JSON.stringify({ type: 'answer', answer: answer }));
        };

        const handleAnswer = async (answer) => {
            await localConnection.setRemoteDescription(new RTCSessionDescription(answer));
        };

        const handleCandidate = async (candidate) => {
            const iceCandidate = new RTCIceCandidate(candidate);
            await localConnection.addIceCandidate(iceCandidate);
        };

        const startConnection = async () => {
            const configuration = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
            localConnection = new RTCPeerConnection(configuration);

            localConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    signalingServer.send(JSON.stringify({ type: 'candidate', candidate: event.candidate }));
                }
            };

            localConnection.ontrack = (event) => {
                document.getElementById('remoteAudio').srcObject = event.streams[0];
            };

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                stream.getTracks().forEach(track => localConnection.addTrack(track, stream));
            } catch (error) {
                console.error('Error accessing media devices.', error);
            }

            const offer = await localConnection.createOffer();
            await localConnection.setLocalDescription(offer);
            signalingServer.send(JSON.stringify({ type: 'offer', offer: offer }));
        };

        startConnection();
    </script>
</body>
</html>
